---

- hosts: localhost
  become: true


  tasks:

  - name: Make Kibana available on all network interfaces
    lineinfile: "dest=/etc/kibana/kibana.yml regexp='^server.host' line='server.host: \"0.0.0.0\"' state=present"

  - name: Create the Kibana logging directory
    file: path=/var/log/kibana/ state=directory owner=kibana group=kibana

  - name: Enable persistent Kibana logs
    lineinfile: "dest=/etc/kibana/kibana.yml regexp='^logging.dest' line='logging.dest: /var/log/kibana/kibana.log' state=present"

  - name: Start Kibana
    service: name=kibana state=restarted

  - name: Wait for Kibana to become available
    wait_for:
      port: 5601
      delay: 5

  - name: Activate monitoring
    command: curl -XPUT 'http://127.0.0.1:5601/api/monitoring/v1/elasticsearch_settings/set/collection_enabled'
    